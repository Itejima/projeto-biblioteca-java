<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Biblioteca</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background-color: #f0f2f5; }
        .container { max-width: 900px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .hidden { display: none; }
        #login-view { max-width: 400px; }
        h1, h2, h3 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        h3 { border-bottom: 1px solid #eee; }
        input[type="text"], input[type="email"], input[type="password"], input[type="number"], textarea, select {
            width: 95%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px;
        }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px; }
        button:hover { background-color: #0056b3; }
        button.danger { background-color: #dc3545; }
        button.danger:hover { background-color: #c82333; }
        #app-header { display: flex; justify-content: space-between; align-items: center; }
        table { border-collapse: collapse; width: 100%; margin-top: 15px; }
        table th, table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        table th { background-color: #f4f4f4; }
        .log { background-color: #222; color: #0f0; padding: 10px; border-radius: 4px; font-family: "Courier New", monospace; margin-top: 10px; height: 150px; overflow-y: auto; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>

    <div id="login-view" class="container">
        <h1>Sistema da Biblioteca</h1>
        <form id="form-login">
            <h2>Login</h2>
            <input type="email" id="login-email" placeholder="Email (ex: carlos@email.com)" required>
            <input type="password" id="login-senha" placeholder="Senha (ex: senhaForte)" required>
            <button type="submit">Entrar</button>
            <button type="button" id="toggle-register-btn">Ir para Registro</button>
        </form>

        <form id="form-registro" class="hidden">
            <h2>Registrar Novo Membro</h2>
            <input type="text" id="reg-nome" placeholder="Nome Completo" required>
            <input type="email" id="reg-email" placeholder="Email" required>
            <input type="password" id="reg-senha" placeholder="Senha" required>
            <input type="hidden" id="reg-grupo" value="3"> <button type="submit">Registrar</button>
            <button type="button" id="toggle-login-btn">Ir para Login</button>
        </form>
    </div>

    <div id="app-view" class="container hidden">
        <div id="app-header">
            <h1 id="app-title">Painel</h1>
            <div>
                <span id="user-info"></span>
                <button id="logout-button" class="danger">Sair</button>
            </div>
        </div>

        <div id="member-view" class="hidden">
            <h2>Membro</h2>
            <h3>Catálogo de Livros Disponíveis</h3>
            <button id="btn-catalogo">Carregar Catálogo</button>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Título</th>
                        <th>Autores</th>
                        <th>Estoque</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody id="lista-catalogo"></tbody>
            </table>
        </div>

        <div id="admin-view" class="hidden">
            <h2>Bibliotecário (Administração)</h2>
            <div class="grid-2">
                <div>
                    <h3>Adicionar Novo Livro</h3>
                    <form id="form-add-livro">
                        <input type="text" id="admin-titulo" placeholder="Título do Livro" required>
                        <input type="text" id="admin-isbn" placeholder="ISBN" required>
                        <input type="number" id="admin-editora" placeholder="ID da Editora (ex: 1)" required>
                        <input type="number" id="admin-ano" placeholder="Ano de Publicação (ex: 2020)" required>
                        <input type="number" id="admin-estoque" placeholder="Qtd. em Estoque" required>
                        <button type="submit">Adicionar Livro</button>
                    </form>
                </div>
                <div>
                    <h3>Gerenciar Catálogo</h3>
                    <p>O catálogo abaixo mostra TODOS os livros (mesmo sem estoque) para gerenciamento. O catálogo de Membros só mostra livros com estoque > 0.</p>
                    <button id="btn-admin-catalogo">Carregar Catálogo Completo</button>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Título</th>
                                <th>Estoque</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody id="admin-lista-catalogo"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <pre id="app-log" class="log"></pre>
    </div>


    <script>
        const API_URL = "http://localhost:8080/api";

        // Elementos da UI
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const memberView = document.getElementById('member-view');
        const adminView = document.getElementById('admin-view');
        const appLog = document.getElementById('app-log');
        const userInfo = document.getElementById('user-info');

        // --- Gerenciamento de Estado (Sessão) ---
        let currentUser = null;

        // Função de Log
        function log(message, data = '') {
            console.log(message, data);
            appLog.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}\n${JSON.stringify(data, null, 2)}\n\n` + appLog.innerHTML;
        }

        // Função Genérica de API
        async function apiFetch(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                };
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(`${API_URL}${endpoint}`, options);
                
                const responseData = await response.json().catch(() => response.text()); // Lê JSON ou texto
                
                if (!response.ok) {
                    const errorMessage = responseData.message || responseData;
                    throw new Error(errorMessage || `Erro ${response.status}`);
                }
                
                return responseData;
            } catch (error) {
                log(`Falha em ${method} ${endpoint}`, { error: error.message });
                alert(`Erro: ${error.message}`);
                throw error; // Re-lança o erro para o chamador
            }
        }


        // --- LÓGICA DE LOGIN / REGISTRO ---

        document.getElementById('toggle-register-btn').addEventListener('click', () => {
            document.getElementById('form-login').classList.add('hidden');
            document.getElementById('form-registro').classList.remove('hidden');
        });
        document.getElementById('toggle-login-btn').addEventListener('click', () => {
            document.getElementById('form-login').classList.remove('hidden');
            document.getElementById('form-registro').classList.add('hidden');
        });

        // Evento: Fazer Login
        document.getElementById('form-login').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                email: document.getElementById('login-email').value,
                senha: document.getElementById('login-senha').value
            };
            try {
                const responseData = await apiFetch('/login', 'POST', data);
                currentUser = responseData; // Salva o usuário globalmente
                showAppView();
            } catch (error) { /* Erro já logado e alertado por apiFetch */ }
        });

        // Evento: Registrar
        document.getElementById('form-registro').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                nome: document.getElementById('reg-nome').value,
                email: document.getElementById('reg-email').value,
                senha: document.getElementById('reg-senha').value,
                idGrupo: parseInt(document.getElementById('reg-grupo').value)
            };
            try {
                await apiFetch('/registrar', 'POST', data);
                alert('Usuário registrado com sucesso! Faça o login.');
                document.getElementById('toggle-login-btn').click(); // Volta para tela de login
            } catch (error) { /* Erro já logado e alertado por apiFetch */ }
        });

        // --- LÓGICA PRINCIPAL DO APP ---

        function showAppView() {
            if (!currentUser) return;
            loginView.classList.add('hidden');
            appView.classList.remove('hidden');
            appLog.innerHTML = ''; 
            
            const userGroupId = currentUser.grupoUsuario.idGrupo; 
            userInfo.innerText = `Bem-vindo(a), ${currentUser.nome}`;

            if (userGroupId === 2) { // 2 = Bibliotecário
                adminView.classList.remove('hidden');
                memberView.classList.add('hidden');
                document.getElementById('app-title').innerText = "Painel de Administração";
                loadAdminCatalog(); // Carrega o catálogo de admin
                log('Sessão iniciada como Bibliotecário.');

            } else { // Padrão para Membro (ID 3)
                memberView.classList.remove('hidden');
                adminView.classList.add('hidden');
                document.getElementById('app-title').innerText = "Painel do Membro";
                loadMemberCatalog(); // Carrega o catálogo de membro
                log('Sessão iniciada como Membro.');
            }
        }

        // Evento: Logout
        document.getElementById('logout-button').addEventListener('click', () => {
            currentUser = null;
            loginView.classList.remove('hidden');
            appView.classList.add('hidden');
            adminView.classList.add('hidden');
            memberView.classList.add('hidden');
        });


        // --- FUNÇÕES DE MEMBRO ---

        document.getElementById('btn-catalogo').addEventListener('click', loadMemberCatalog);

        async function loadMemberCatalog() {
            try {
                const data = await apiFetch('/catalogo');
                const tbody = document.getElementById('lista-catalogo');
                tbody.innerHTML = '';
                if (data.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="5">Nenhum livro disponível no momento.</td></tr>';
                     return;
                }
                data.forEach(livro => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${livro.id_livro}</td>
                            <td>${livro.titulo}</td>
                            <td>${livro.autores}</td>
                            <td>${livro.quantidade_estoque}</td>
                            <td>
                                <button onclick="handleEmprestimo(${livro.id_livro})">Emprestar</button>
                            </td>
                        </tr>`;
                });
                log('Catálogo de Membro carregado.');
            } catch (error) { /* Erro já logado e alertado por apiFetch */ }
        }

        async function handleEmprestimo(idLivro) {
            if (!currentUser) return;
            if (!confirm(`Deseja pegar emprestado o livro ID ${idLivro}?`)) return;
            
            const data = {
                idUsuario: currentUser.idUsuario,
                idLivro: idLivro
            };

            try {
                const responseData = await apiFetch('/emprestimos', 'POST', data);
                log('Empréstimo realizado com sucesso!', responseData);
                alert('Empréstimo realizado com sucesso! O livro é seu por 7 dias.');
                loadMemberCatalog(); // Recarrega o catálogo
            } catch (error) { /* Erro já logado e alertado por apiFetch */ }
        }


        // --- FUNÇÕES DE BIBLIOTECÁRIO (ADMIN) ---

        // Carregar Catálogo de Admin (mostra todos os livros)
        document.getElementById('btn-admin-catalogo').addEventListener('click', loadAdminCatalog);
        
        async function loadAdminCatalog() {
            try {
                // Estamos reusando o /catalogo, mas o ideal seria um /api/livros/admin
                const data = await apiFetch('/catalogo');
                const tbody = document.getElementById('admin-lista-catalogo');
                tbody.innerHTML = '';
                if (data.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="4">Nenhum livro cadastrado.</td></tr>';
                     return;
                }
                data.forEach(livro => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${livro.id_livro}</td>
                            <td>${livro.titulo}</td>
                            <td>${livro.quantidade_estoque}</td>
                            <td>
                                <button class="danger" onclick="handleDeleteBook(${livro.id_livro})">Deletar</button>
                            </td>
                        </tr>`;
                });
                log('Catálogo de Admin carregado.');
            } catch (error) { /* Erro já logado e alertado por apiFetch */ }
        }

        // Adicionar Livro
        document.getElementById('form-add-livro').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                titulo: document.getElementById('admin-titulo').value,
                isbn: document.getElementById('admin-isbn').value,
                idEditora: parseInt(document.getElementById('admin-editora').value),
                anoPublicacao: parseInt(document.getElementById('admin-ano').value),
                quantidadeEstoque: parseInt(document.getElementById('admin-estoque').value)
            };

            try {
                const responseData = await apiFetch('/livros', 'POST', data);
                log('Livro adicionado com sucesso!', responseData);
                alert('Livro adicionado com sucesso!');
                document.getElementById('form-add-livro').reset(); // Limpa o formulário
                loadAdminCatalog(); // Recarrega a lista
            } catch (error) { /* Erro já logado e alertado por apiFetch */ }
        });
        
        // Deletar Livro
        async function handleDeleteBook(idLivro) {
            if (!confirm(`Tem certeza que deseja DELETAR o livro ID ${idLivro}? Esta ação não pode ser desfeita.`)) return;

            try {
                const responseData = await apiFetch(`/livros/${idLivro}`, 'DELETE');
                log('Livro deletado com sucesso!', responseData);
                alert('Livro deletado com sucesso!');
                loadAdminCatalog(); // Recarrega a lista
            } catch (error) { /* Erro já logado e alertado por apiFetch */ }
        }

    </script>
</body>
</html>